<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Send Location to Google Sheets</title>
</head>
<body>
    <h2>Send Location to Google Sheets</h2>

    <button id="getLocationBtn">Send My Location</button>

    <script>
        // تحديد الوقت الذي يتمكن فيه المستخدم من التسجيل
        let registrationOpenTime = new Date("2024-10-09T02:25:00");

        // Function to check if the current date and time is past the allowed date and time
        function canRegister() {
            const currentTime = new Date();
            return currentTime >= registrationOpenTime;
        }

        // Function to check if the user has already submitted their location
        function checkSubmission() {
            const lastSubmissionTime = localStorage.getItem('submissionTime');
            const currentTime = new Date().getTime();

            // إذا كان هناك وقت تسجيل سابق
            if (lastSubmissionTime) {
                // إذا كان الوقت الجديد أكبر من وقت التسجيل السابق، امسح التخزين المحلي
                if (currentTime > registrationOpenTime.getTime()) {
                    localStorage.removeItem('submissionTime');
                } else {
                    // إذا لم يتجاوز الوقت المسموح، عطل الزر
                    document.getElementById('getLocationBtn').disabled = true;
                    document.getElementById('getLocationBtn').innerText = "التسجيل غير مسموح به!";
                    return;
                }
            }
        }

        // Check the user's submission status
        checkSubmission();

        document.getElementById('getLocationBtn').addEventListener('click', function() {
            // تحقق مما إذا كان التسجيل مسموحًا
            if (!canRegister()) {
                alert("التسجيل غير مسموح به قبل الوقت المحدد.");
                return;
            }

            // إذا تم تسجيل الموقع بالفعل، عطل الزر
            if (localStorage.getItem('submissionTime')) {
                alert("لقد أرسلت موقعك بالفعل!");
                return;
            }

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(successCallback, errorCallback);
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        });

        function successCallback(position) {
            var latitude = position.coords.latitude;
            var longitude = position.coords.longitude;

            // Check if the location is within the defined boundaries
            var latMin = 30.352578455960234;
            var latMax = 30.35940277445104;
            var lonMin = 31.21760913869633;
            var lonMax = 31.2265650558797;

            var statusMessage;

            if (latitude >= latMin && latitude <= latMax && longitude >= lonMin && longitude <= lonMax) {
                statusMessage = "الموقع داخل المنطقة المحددة!";
            } else {
                statusMessage = "الموقع خارج المنطقة المحددة!";
            }

            // Get the user's IP address
            fetch('https://api.ipify.org?format=json')
                .then(response => response.json())
                .then(ipData => {
                    var ipAddress = ipData.ip;

                    // Prepare data to be sent to SheetDB
                    var data = {
                        data: [
                            {
                                latitude: latitude,
                                longitude: longitude,
                                ip: ipAddress,
                                status: statusMessage
                            }
                        ]
                    };

                    // Send data to SheetDB
                    fetch("https://sheetdb.io/api/v1/cz1zby000bc2d", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(data)
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log("Location and IP submitted successfully:", data);
                        alert(statusMessage);

                        // Save the current time as the submission time
                        localStorage.setItem('submissionTime', new Date().getTime());

                        // Disable the button and change its text
                        document.getElementById('getLocationBtn').disabled = true;
                        document.getElementById('getLocationBtn').innerText = "لقد أرسلت موقعك بالفعل!";
                    })
                    .catch(error => {
                        console.error("Error:", error);
                        alert("Error submitting location: " + error.message);
                    });
                })
                .catch(error => {
                    console.error("Error getting IP address:", error);
                });
        }

        function errorCallback(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    alert("User denied the request for Geolocation.");
                    break;
                case error.POSITION_UNAVAILABLE:
                    alert("Location information is unavailable.");
                    break;
                case error.TIMEOUT:
                    alert("The request to get user location timed out.");
                    break;
                case error.UNKNOWN_ERROR:
                    alert("An unknown error occurred.");
                    break;
            }
        }
    </script>
</body>
</html>
